<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-localize-mixin/app-localize-mixin.html">
<link rel="import" href="../goc-apps/goc-app-icon.html">
<link rel="import" href="../goc-apps/goc-apps-collection.html">
<link rel="import" href="../goc-icons/goc-icons.html">
<link rel="import" href="../goc-styles/goc-styles.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../input-file/input-file.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-image/iron-image.html">

<dom-module id="app-image">
  <template>
    <style include="header-layout-styles btn-styles icon-btn-styles missing-well-styles">
      :host {
        display: block;
      }

      [hidden] {
        display: none !important;
      }

      .header-layout__content {
        padding: 20px;
      }

      #inputFile {
        display: none;
      }

      #ironImage {
        width: 100%;
        height: 100%;
      }
    </style>

    <input-file
        id="inputFile"
        multiple="false"
        on-files-selected="_onFileSelected"
        on-files-loaded="_onFileLoaded"></input-file>

    <goc-apps-collection
        app-name="image"
        item="{{appInfo}}"
        language="[[language]]"></goc-apps-collection>

    <div class="header-layout">
      <div class="header-layout__header">
        <div class="header-toolbar">
          <button
              class="icon-btn icon-btn--primary"
              on-click="_onBackTapped"
              title="[[localize('EditorPage.Header.BackButton')]]">
              <touch-item><iron-icon icon="arrow-back"></iron-icon></touch-item>
          </button>

          <goc-app-icon size="small" app-name="image"></goc-app-icon>

          <div class="header-toolbar__main-content">
            <div class="header-toolbar__title">[[contentName]]</div>
            <div class="header-toolbar__subtitle">[[appInfo.displayName]]</div>
          </div>

          <paper-spinner-lite class="header-layout__spinner" active="[[loading]]"></paper-spinner-lite>

          <button
              class="icon-btn icon-btn--primary"
              on-click="_onAddPhotoTapped"
              title="[[localize('EditorPage.Header.AddButton')]]">
              <touch-item><iron-icon icon="add-photo"></iron-icon></touch-item>
          </button>
        </div>
      </div>

      <div class="header-layout__content">
        <iron-image
            id="ironImage"
            loading="{{_imageLoading}}"
            src="[[_imageUrl]]"
            sizing="contain"
            hidden$="[[!_imageUrl]]"
            on-error-changed="_onIronImageErrorChanged">
        </iron-image>

        <dom-if if="[[_computeMissingWellVisible(loading, _imageLoading, data)]]">
          <template>
            <div class="missing-well">
              <div class="missing-well__title">[[localize('EditorPage.List.Empty.Title')]]</div>
            </div>
          </template>
        </dom-if>
      </div>
    </div>
  </template>

  <script>

    class AppImage extends AppLocalizeMixin(Polymer.Element) {

      static get is() {return 'app-image';}

      static get config() {
        return {
          properties: {

            data: {
              type: Object,
              value: _ => {
                return {};
              },
              observer: '_dataChanged'
            },

            release: Object,

            contentId: Number,

            dataUpdatedAt: Number,

            releaseUpdatedAt: Number,

            contentName: String,

            loading: {
              type: Boolean,
              value: false
            },

            language: {
              type: String,
              value: _ => 'en'
            },

            resources: {
              type: Object,
              value() {
                return {
                  en: {
                    'EditorPage.Header.AddButton': 'Upload image',
                    'EditorPage.Header.BackButton': 'Back',
                    'EditorPage.List.Empty.Title': 'Upload an image by clicking on the top right button',
                  },

                  es: {
                    'EditorPage.Header.AddButton': 'Subir imagen',
                    'EditorPage.Header.BackButton': 'Atrás',
                    'EditorPage.List.Empty.Title': 'Para subir una imagen haz click en el botón de la esquina superior derecha',
                  }
                };
              }
            },

            _imageUrl: String

          }
        };
      }

      constructor() {
        super();
        this._lastFile = null;
      }

      _dataChanged(data) {
        this._updateImage();
      }

      _onAddPhotoTapped() {
        this.$.inputFile.selectFiles();
      }

      _onBackTapped() {
        this.dispatchEvent(new Event('close-app', {composed: true}));
      }

      _onIronImageErrorChanged(event) {
        const error = event.detail.value;

        if (error && this._lastFile) {
          this._imageUrl = URL.createObjectURL(this._lastFile);
        }
      }

      _onFileSelected(event) {
        this.loading = true;
      }

      _onFileLoaded(event) {
        const file = event.detail.files[0];
        this._lastFile = file;

        if (file.images) {
          if (!this.data) {
            this.data = {};
          }

          this.data.imageUrl = file.images[0].url;
          this._updateImage();
          this._notifyContentUpdate();
        }
      }

      _updateImage() {
        if (this.data) {
          this._imageUrl = this.data.imageUrl || false;
        }
      }

      _notifyContentUpdate() {
        this.dispatchEvent(new CustomEvent('content-update', {
          composed: true,
          detail: {
            data: this.data,
            contentId: this.contentId,
            // directly to channel release
            updateRelease: true,
          }
        }));
      }

      _computeMissingWellVisible(loading, imageLoading, data) {
        return !loading && !imageLoading && data && !data.imageUrl;
      }

    }

    customElements.define(AppImage.is, AppImage);

  </script>
</dom-module>
